"use strict";
const conversions = require("webidl-conversions");
const HTMLElementImpl = require("./HTMLElement-impl").implementation;
<<<<<<< HEAD
const resourceLoader = require("../../browser/resource-loader");
=======
>>>>>>> 39a8ac91c1203e59702c1b86c18a4c5e5058db03
const { Canvas, reflectURLAttribute } = require("../../utils");

class HTMLImageElementImpl extends HTMLElementImpl {
  _attrModified(name, value, oldVal) {
    if (name === "src" && value !== oldVal) {
      const document = this._ownerDocument;
<<<<<<< HEAD
      if (Canvas && document.implementation._hasFeature("FetchExternalResources", "img")) {
=======
      if (Canvas) {
>>>>>>> 39a8ac91c1203e59702c1b86c18a4c5e5058db03
        let error;
        if (!this._image) {
          this._image = new Canvas.Image();
          // Install an error handler that just remembers the error. It is then
<<<<<<< HEAD
          // thrown in the callback of resourceLoader.load() below.
=======
          // thrown in the callback of resourceLoader.fetch() below.
>>>>>>> 39a8ac91c1203e59702c1b86c18a4c5e5058db03
          this._image.onerror = function (err) {
            error = err;
          };
        }
        this._currentSrc = null;
<<<<<<< HEAD
        if (this.hasAttribute("src")) {
          resourceLoader.load(this, this.src, {}, (data, url, response) => {
=======
        if (this.hasAttributeNS(null, "src")) {
          const resourceLoader = document._resourceLoader;
          let request;

          const onLoadImage = data => {
            const { response } = request;

>>>>>>> 39a8ac91c1203e59702c1b86c18a4c5e5058db03
            if (response && response.statusCode !== undefined && response.statusCode !== 200) {
              throw new Error("Status code: " + response.statusCode);
            }
            error = null;
<<<<<<< HEAD
            this._image.source = data;
=======
            this._image.src = data;
>>>>>>> 39a8ac91c1203e59702c1b86c18a4c5e5058db03
            if (error) {
              throw new Error(error);
            }
            this._currentSrc = value;
<<<<<<< HEAD
          });
        } else {
          this._image.source = undefined;
=======
          };

          request = resourceLoader.fetch(this.src, {
            element: this,
            onLoad: onLoadImage
          });
        } else {
          this._image.src = "";
>>>>>>> 39a8ac91c1203e59702c1b86c18a4c5e5058db03
        }
      }
    }

    super._attrModified(name, value, oldVal);
  }

  get _accept() {
    return "image/png,image/*;q=0.8,*/*;q=0.5";
  }

  get src() {
    return reflectURLAttribute(this, "src");
  }

  set src(value) {
<<<<<<< HEAD
    this.setAttribute("src", value);
  }

  get srcset() {
    return conversions.USVString(this.getAttribute("srcset"));
  }

  set srcset(value) {
    this.setAttribute("srcset", value);
=======
    this.setAttributeNS(null, "src", value);
  }

  get srcset() {
    return conversions.USVString(this.getAttributeNS(null, "srcset"));
  }

  set srcset(value) {
    this.setAttributeNS(null, "srcset", value);
>>>>>>> 39a8ac91c1203e59702c1b86c18a4c5e5058db03
  }

  get height() {
    // Just like on browsers, if no width / height is defined, we fall back on the
    // dimensions of the internal image data.
<<<<<<< HEAD
    return this.hasAttribute("height") ?
           conversions["unsigned long"](this.getAttribute("height")) :
=======
    return this.hasAttributeNS(null, "height") ?
           conversions["unsigned long"](this.getAttributeNS(null, "height")) :
>>>>>>> 39a8ac91c1203e59702c1b86c18a4c5e5058db03
           this.naturalHeight;
  }

  set height(V) {
<<<<<<< HEAD
    this.setAttribute("height", String(V));
  }

  get width() {
    return this.hasAttribute("width") ?
           conversions["unsigned long"](this.getAttribute("width")) :
=======
    this.setAttributeNS(null, "height", String(V));
  }

  get width() {
    return this.hasAttributeNS(null, "width") ?
           conversions["unsigned long"](this.getAttributeNS(null, "width")) :
>>>>>>> 39a8ac91c1203e59702c1b86c18a4c5e5058db03
           this.naturalWidth;
  }

  set width(V) {
<<<<<<< HEAD
    this.setAttribute("width", String(V));
  }

  get naturalHeight() {
    return this._image ? this._image.height : 0;
  }

  get naturalWidth() {
    return this._image ? this._image.width : 0;
=======
    this.setAttributeNS(null, "width", String(V));
  }

  get naturalHeight() {
    return this._image ? this._image.naturalHeight : 0;
  }

  get naturalWidth() {
    return this._image ? this._image.naturalWidth : 0;
>>>>>>> 39a8ac91c1203e59702c1b86c18a4c5e5058db03
  }

  get complete() {
    return Boolean(this._image && this._image.complete);
  }

  get currentSrc() {
    return this._currentSrc || "";
  }

  get lowsrc() {
    return reflectURLAttribute(this, "lowsrc");
  }

  set lowsrc(value) {
<<<<<<< HEAD
    this.setAttribute("lowsrc", value);
=======
    this.setAttributeNS(null, "lowsrc", value);
>>>>>>> 39a8ac91c1203e59702c1b86c18a4c5e5058db03
  }

  get longDesc() {
    return reflectURLAttribute(this, "longdesc");
  }

  set longDesc(value) {
<<<<<<< HEAD
    this.setAttribute("longdesc", value);
=======
    this.setAttributeNS(null, "longdesc", value);
>>>>>>> 39a8ac91c1203e59702c1b86c18a4c5e5058db03
  }
}

module.exports = {
  implementation: HTMLImageElementImpl
};
