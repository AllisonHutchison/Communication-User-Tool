'use strict';
// https://github.com/tc39/proposal-iterator-helpers
var $ = require('../internals/export');
<<<<<<< HEAD
var global = require('../internals/global');
var call = require('../internals/function-call');
var aCallable = require('../internals/a-callable');
=======
var aFunction = require('../internals/a-function');
>>>>>>> 39a8ac91c1203e59702c1b86c18a4c5e5058db03
var anObject = require('../internals/an-object');
var getIteratorMethod = require('../internals/get-iterator-method');
var createIteratorProxy = require('../internals/iterator-create-proxy');
var iteratorClose = require('../internals/iterator-close');

<<<<<<< HEAD
var TypeError = global.TypeError;

var IteratorProxy = createIteratorProxy(function () {
=======
var IteratorProxy = createIteratorProxy(function (arg) {
>>>>>>> 39a8ac91c1203e59702c1b86c18a4c5e5058db03
  var iterator = this.iterator;
  var mapper = this.mapper;
  var result, mapped, iteratorMethod, innerIterator;

  while (true) {
    try {
      if (innerIterator = this.innerIterator) {
<<<<<<< HEAD
        result = anObject(call(this.innerNext, innerIterator));
=======
        result = anObject(this.innerNext.call(innerIterator));
>>>>>>> 39a8ac91c1203e59702c1b86c18a4c5e5058db03
        if (!result.done) return result.value;
        this.innerIterator = this.innerNext = null;
      }

<<<<<<< HEAD
      result = anObject(call(this.next, iterator));
=======
      result = anObject(this.next.call(iterator, arg));
>>>>>>> 39a8ac91c1203e59702c1b86c18a4c5e5058db03

      if (this.done = !!result.done) return;

      mapped = mapper(result.value);
      iteratorMethod = getIteratorMethod(mapped);

<<<<<<< HEAD
      if (!iteratorMethod) {
        throw TypeError('.flatMap callback should return an iterable object');
      }

      this.innerIterator = innerIterator = anObject(call(iteratorMethod, mapped));
      this.innerNext = aCallable(innerIterator.next);
    } catch (error) {
      iteratorClose(iterator, 'throw', error);
=======
      if (iteratorMethod === undefined) {
        throw TypeError('.flatMap callback should return an iterable object');
      }

      this.innerIterator = innerIterator = anObject(iteratorMethod.call(mapped));
      this.innerNext = aFunction(innerIterator.next);
    } catch (error) {
      iteratorClose(iterator);
      throw error;
>>>>>>> 39a8ac91c1203e59702c1b86c18a4c5e5058db03
    }
  }
});

$({ target: 'Iterator', proto: true, real: true }, {
  flatMap: function flatMap(mapper) {
    return new IteratorProxy({
      iterator: anObject(this),
<<<<<<< HEAD
      mapper: aCallable(mapper),
=======
      mapper: aFunction(mapper),
>>>>>>> 39a8ac91c1203e59702c1b86c18a4c5e5058db03
      innerIterator: null,
      innerNext: null
    });
  }
});
