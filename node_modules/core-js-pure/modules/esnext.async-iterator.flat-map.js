'use strict';
// https://github.com/tc39/proposal-iterator-helpers
var $ = require('../internals/export');
<<<<<<< HEAD
var call = require('../internals/function-call');
var aCallable = require('../internals/a-callable');
var anObject = require('../internals/an-object');
var createAsyncIteratorProxy = require('../internals/async-iterator-create-proxy');
var getAsyncIterator = require('../internals/get-async-iterator');

var AsyncIteratorProxy = createAsyncIteratorProxy(function (Promise) {
  var state = this;
  var mapper = state.mapper;
  var innerIterator;
=======
var aFunction = require('../internals/a-function');
var anObject = require('../internals/an-object');
var createAsyncIteratorProxy = require('../internals/async-iterator-create-proxy');
var getAsyncIteratorMethod = require('../internals/get-async-iterator-method');

var AsyncIteratorProxy = createAsyncIteratorProxy(function (arg, Promise) {
  var state = this;
  var mapper = state.mapper;
  var innerIterator, iteratorMethod;
>>>>>>> 39a8ac91c1203e59702c1b86c18a4c5e5058db03

  return new Promise(function (resolve, reject) {
    var outerLoop = function () {
      try {
<<<<<<< HEAD
        Promise.resolve(anObject(call(state.next, state.iterator))).then(function (step) {
=======
        Promise.resolve(anObject(state.next.call(state.iterator, arg))).then(function (step) {
>>>>>>> 39a8ac91c1203e59702c1b86c18a4c5e5058db03
          try {
            if (anObject(step).done) {
              state.done = true;
              resolve({ done: true, value: undefined });
            } else {
              Promise.resolve(mapper(step.value)).then(function (mapped) {
                try {
<<<<<<< HEAD
                  state.innerIterator = innerIterator = getAsyncIterator(mapped);
                  state.innerNext = aCallable(innerIterator.next);
                  return innerLoop();
=======
                  iteratorMethod = getAsyncIteratorMethod(mapped);
                  if (iteratorMethod !== undefined) {
                    state.innerIterator = innerIterator = anObject(iteratorMethod.call(mapped));
                    state.innerNext = aFunction(innerIterator.next);
                    return innerLoop();
                  } reject(TypeError('.flatMap callback should return an iterable object'));
>>>>>>> 39a8ac91c1203e59702c1b86c18a4c5e5058db03
                } catch (error2) { reject(error2); }
              }, reject);
            }
          } catch (error1) { reject(error1); }
        }, reject);
      } catch (error) { reject(error); }
    };

    var innerLoop = function () {
      if (innerIterator = state.innerIterator) {
        try {
<<<<<<< HEAD
          Promise.resolve(anObject(call(state.innerNext, innerIterator))).then(function (result) {
=======
          Promise.resolve(anObject(state.innerNext.call(innerIterator))).then(function (result) {
>>>>>>> 39a8ac91c1203e59702c1b86c18a4c5e5058db03
            try {
              if (anObject(result).done) {
                state.innerIterator = state.innerNext = null;
                outerLoop();
              } else resolve({ done: false, value: result.value });
            } catch (error1) { reject(error1); }
          }, reject);
        } catch (error) { reject(error); }
      } else outerLoop();
    };

    innerLoop();
  });
});

$({ target: 'AsyncIterator', proto: true, real: true }, {
  flatMap: function flatMap(mapper) {
    return new AsyncIteratorProxy({
      iterator: anObject(this),
<<<<<<< HEAD
      mapper: aCallable(mapper),
=======
      mapper: aFunction(mapper),
>>>>>>> 39a8ac91c1203e59702c1b86c18a4c5e5058db03
      innerIterator: null,
      innerNext: null
    });
  }
});
